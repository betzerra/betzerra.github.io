I"…#<p>It‚Äôs been a while I‚Äôve been thinking about writing about <a href="https://fastlane.tools">Fastlane</a> and <a href="https://danger.systems">Danger</a>.</p>

<p>Basically, because <strong>I hate manual processes</strong>. I do. They are boring, require lots of time and they‚Äôre prone to human errors. The more boring the task is, the more likely to fuck it up I am.</p>

<p>So automating these tasks are (for me and probably for you too) not just a way of being happier at work, but also a sort of safety net. Of course you‚Äôll need to invest some time on it, and it will probably need a couple of iterations after you‚Äôre 100% happy with it. But it pays off quickly, I promise :-)</p>

<p>On this post I‚Äôll make an introduction about <strong>Danger</strong> and give some examples of what you can do with it <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>.</p>

<h1 id="getting-started-before-getting-started">Getting started before ‚ÄúGetting started‚Äù</h1>
<p>First of all, I need to give you a tip regardless you agree with me at the end of this post or not. Cocoapods, Danger <sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup> and Fastlane are tools written in Ruby. If you‚Äôre using any of these, I recommend you to:</p>

<ul>
  <li><a href="https://rvm.io">Use RVM</a><sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup> so you can have many versions of Ruby in your system. This will avoid some possible issues in the future.</li>
  <li><a href="https://bundler.io">Use Bundler</a>, this will allow you to get multiple versions of ruby gems. This means that you can have Cocoapods <code class="language-plaintext highlighter-rouge">1.4.0</code> on one project, and <code class="language-plaintext highlighter-rouge">1.5.3</code> on another.</li>
  <li>Write your dependencies on a <a href="https://github.com/Canillitapp/headlines-iOS/blob/master/Gemfile">Gemfile</a>.</li>
</ul>

<h1 id="so-whats-danger">So‚Ä¶ what‚Äôs Danger?</h1>
<p>Well, <a href="https://danger.systems/ruby/">the website has a great explanation</a> but the TLDR; version would be:</p>

<blockquote>
  <p>it‚Äôs a script that runs on the CI phase and it will send messages on your pull request depending on some rules you wrote on the <a href="https://github.com/Canillitapp/headlines-iOS/blob/master/Dangerfile">Dangerfile</a></p>
</blockquote>

<p><img src="http://betzerra.github.io/assets/danger_demo.png" alt="Danger bot working" /></p>

<p>Still confused? Here are some examples:</p>

<ul>
  <li>check if my code complies with project‚Äôs code style.</li>
  <li>warn me to update <code class="language-plaintext highlighter-rouge">changelog.md</code> if I forgot.</li>
  <li>if it‚Äôs a release branch, remind me to tag this commit after it‚Äôs approved.</li>
  <li>if the PR is still in progress, warn my teammates.</li>
  <li>if my PR is too long remind me to make changes as atomic as possible next time.</li>
  <li>if some core files are modified, maybe it‚Äôs a good idea to notify top contributors</li>
  <li>if it‚Äôs an Open Source project, thank other contributors.</li>
</ul>

<p>On top of that, I‚Äôll add that apart from preventing humans to do those chores, it removes the friction of being the bad cop that asks developers to remove that extra whitespace ;-)</p>

<h1 id="dangerfile">Dangerfile</h1>
<p>So, once you have an idea of what are the rules you want to implement, you just write these on a file called <code class="language-plaintext highlighter-rouge">Dangerfile</code>, here‚Äôs an example (Ruby developers will find this quite easy):</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># check if my code complies with project's code style.</span>
<span class="n">swiftlint</span><span class="p">.</span><span class="nf">lint_files</span> <span class="ss">inline_mode: </span><span class="kp">true</span>

<span class="c1"># warn me to update changelog.md file if I forgot.</span>
<span class="n">no_changelog_entry</span> <span class="o">=</span> <span class="o">!</span><span class="n">git</span><span class="p">.</span><span class="nf">modified_files</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s2">"changelog.md"</span><span class="p">)</span>
<span class="k">if</span> <span class="n">no_changelog_entry</span>
  <span class="n">warn_text</span> <span class="o">=</span> <span class="s1">'Please consider adding a note to our changelog if its required.'</span>
  <span class="nb">warn</span><span class="p">(</span><span class="n">warn_text</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># if it‚Äôs a release branch, remind me to tag this commit after it‚Äôs approved.</span>
<span class="k">if</span> <span class="n">github</span><span class="p">.</span><span class="nf">branch_for_head</span><span class="p">.</span><span class="nf">include?</span> <span class="s1">'release'</span>
  <span class="n">message_text</span> <span class="o">=</span> <span class="s2">"""
  This looks like a release PR.
  Don't forget to:
  - Tag the version.
  - Write the changelog.
  - Build a version and deploy to QA.
  """</span>
  <span class="n">message</span><span class="p">(</span><span class="n">message_text</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># if the PR is still in progress, warn my teammates.</span>
<span class="nb">warn</span><span class="p">(</span><span class="s2">"PR is classed as Work in Progress"</span><span class="p">)</span> <span class="k">if</span> <span class="n">github</span><span class="p">.</span><span class="nf">pr_title</span><span class="p">.</span><span class="nf">include?</span> <span class="s2">"[WIP]"</span>

<span class="c1"># if my PR is too long remind me to make changes as atomic as possible next time.</span>
<span class="nb">warn</span><span class="p">(</span><span class="s2">"Big PR"</span><span class="p">)</span> <span class="k">if</span> <span class="n">git</span><span class="p">.</span><span class="nf">lines_of_code</span> <span class="o">&gt;</span> <span class="mi">500</span>

<span class="c1"># if some core files are modified, maybe it's a good idea to notify top contributors</span>
<span class="n">modified_core_files</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">git</span><span class="p">.</span><span class="nf">modified_files</span><span class="p">.</span><span class="nf">grep</span><span class="p">(</span><span class="sr">/core/</span><span class="p">).</span><span class="nf">empty?</span><span class="p">)</span>
<span class="k">if</span> <span class="n">modified_core_files</span>
  <span class="n">message</span><span class="p">(</span><span class="s1">'Heads up @betzerra . This might be important'</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># if it‚Äôs an Open Source project, thank other contributors.</span>
<span class="n">message</span><span class="p">(</span><span class="s2">"Thanks @</span><span class="si">#{</span><span class="n">github</span><span class="p">.</span><span class="nf">pr_author</span><span class="si">}</span><span class="s2">! :tada:"</span><span class="p">)</span> <span class="k">if</span> <span class="n">github</span><span class="p">.</span><span class="nf">pr_author</span> <span class="o">!=</span> <span class="s2">"betzerra"</span>
</code></pre></div></div>

<p>Check Danger‚Äôs website for more examples.</p>

<h1 id="setup-dangerfile">Setup Dangerfile</h1>
<ul>
  <li>Add Danger and its plugins (if needed) on your Gemfile. <a href="https://github.com/Canillitapp/headlines-iOS/blob/master/Gemfile">See an example</a></li>
  <li>Setup an account on Github / Gitlab / Bitbucket for the bot. This is probably the most annoying part. Follow <a href="https://danger.systems/guides/getting_started.html">these instructions</a>.</li>
  <li>Setup your CI file to run Danger. <a href="https://github.com/Canillitapp/headlines-iOS/blob/master/.travis.yml">See an example on TravisCI</a></li>
  <li>???</li>
  <li>Profit</li>
</ul>

<p>By now, you should have your own Danger bot working on your repos. Kudos!
Let me know your doubts / opinions via twitter @betzerra or by email!</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>I‚Äôll talk about Fastlane on the next post.¬†<a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>There‚Äôs a javascript version for Danger, but <a href="https://www.destroyallsoftware.com/talks/wat">javascript sucks</a>.¬†<a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>I heard <a href="https://github.com/rbenv/rbenv">rbenv</a> is great too but I use RVM so‚Ä¶ ü§∑¬†<a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
:ET